from reportlab.platypus import Paragraph, Spacer,  ListFlowable, ListItem, Image,PageBreak
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors
from reportlab.lib.units import inch
from reportlab.lib.pagesizes import A4

from vdmp_dashboard.models import HouseholdSurvey,VillageRoadInfo, VillageRoadInfoErosion,Critical_Facility,ElectricPole,Transformer
import os
from django.db.models import Sum,Avg,Q,Count

from .global_styles import blue_heading, table_sub_title, blue_sub_heading, image_title, blue_level3_heading, indented_style,srNoStyle,tb_header_bg,bold_style,center_style,bold_center_style,normal_style,non_indented_style
from .utils.table import create_styled_table
import requests
from village_profile.models import tblVillage
from .utils.geoserverLayerImage import  get_geoserver_legend_path,get_geoserver_image_as_rl_image
from reportlab.platypus import Image as ReportLabImage, Table as ReportLabTable, TableStyle
page_width, page_height = A4
from vdmp_dashboard.models import VDMP_Maps_Data
from assam_crv.settings import MEDIA_ROOT


def getHazardPresenceData():
    return [
        ["Sr No.","Hazard Type", "Likelihood", "Impact Level", "Vulnerable Area/Group"],
        ['1',"Flood", "High", "Moderate", Paragraph(f"Entire agricultural land and 84% of households")],
        ['2',"Earthquake", "Low", "Severe", Paragraph(f"Entire village")],
        ['3',"Strong Wind", "High", "Low", Paragraph("Damage to electric network. Damage to tin roof houses which are poorly constructed")],
        ['4',"Landslide", "Nil", "Nil", "Nil"],
        ['5',"Heatwave", "Moderate", "Low", Paragraph("Agricultural community and people in tin houses, especially pregnant women, lactating mothers, infants, ailing and elderly people")]
    ]
    
    
def getEarthquakeMMITableData():
    return [
        ['Sr No.',"PGA (g)", "MMI", "Category", "Description"],
        [
            '1',"0.75 – 1.39",
            "IX",
            "Violent",
            Paragraph("People experience strong ground shaking and fear; objects are thrown. Ground cracks and surface failures occur. Well-built structures face substantial damage, while poorly built ones may collapse.")
        ]
    ]
    
def getHazardCharacteristics(village_id):
    try:
        # Get averages from HH table in single query
        averages = HouseholdSurvey.objects.filter(village=village_id).aggregate(
            avg_house_flood=Avg('maximum_flood_height_in_house_ft'),
            avg_agri_flood=Avg('maximum_flood_height_experience_in_your_agriculture_ft')
        )
        
        avg_house_flood = averages['avg_house_flood'] or 0
        avg_agri_flood = averages['avg_agri_flood'] or 0
        
        return [
            ["Sr. No.", "Flood characteristics", "Details"],
            ["1", "Flood extend", "Entire village"],
            ["2", "Flood duration", "2 months"],
            ["3", "Flood frequency within year", "1-2 times a year"],
            ["4", "Occurrence of extreme flood", "Once in 5 years"],
            ["5", "Average flood depth in built-up area", f"{avg_house_flood:.2f} feet"],
            ["6", "Average flood depth in agricultural land", f"{avg_agri_flood:.1f} feet"]
        ]
    except Exception:
        return [
            ["Sr. No.", "Flood characteristics", "Details"],
            ["1", "Flood extend", "Entire village"],
            ["2", "Flood duration", "2 months"],
            ["3", "Flood frequency within year", "1-2 times a year"],
            ["4", "Occurrence of extreme flood", "Once in 5 years"],
            ["5", "Average flood depth in built-up area", "2.23 feet"],
            ["6", "Average flood depth in agricultural land", "9.0 feet"]
        ]   


def getHazardCalender(village_id):
    return [
        ["Sr. No.", Paragraph("Weather/Hazard Calendar",bold_center_style),"Months"],
        [Paragraph(""), Paragraph(""), Paragraph("Jan",bold_center_style), Paragraph("Feb",bold_center_style), Paragraph("Mar",bold_center_style), Paragraph("Apr",bold_center_style), Paragraph("May",bold_center_style), Paragraph("Jun",bold_center_style), Paragraph("Jul",bold_center_style), Paragraph("Aug",bold_center_style), Paragraph("Sep",bold_center_style), Paragraph("Oct",bold_center_style), Paragraph("Nov",bold_center_style), Paragraph("Dec",bold_center_style)],
        ['1', Paragraph("Temperature"), Paragraph("Pleasant",center_style), Paragraph("Pleasant",center_style), Paragraph("Warm",center_style), Paragraph("Hot/Heat Wave",center_style), Paragraph("Hot/Heat Wave",center_style), Paragraph("Warm",center_style), Paragraph("Warm",center_style), Paragraph("Warm",center_style), Paragraph("Warm",center_style), Paragraph("Pleasant",center_style), Paragraph("Pleasant",center_style)],
        
        ['2', Paragraph("Rainfall" ), Paragraph("Dry",center_style), Paragraph("Dry",center_style), Paragraph("Low",center_style), Paragraph("Low",center_style), Paragraph("High",center_style), Paragraph("High",center_style),"","","", Paragraph("Low"), Paragraph("Dry")],
        
        ['3', Paragraph("Flood"), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph("Flood/Flash Flood",center_style), Paragraph("Flood/Flash Flood"), Paragraph("Flood/Flash Flood"), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph("")],
        ['4', Paragraph("Strong wind"), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph("Moderate",center_style), Paragraph("Moderate",center_style), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph(""), Paragraph("")],
        ['5', Paragraph("Earthquake"), "High"]
    ]
    
def getErosionCharacteristics(village_id):
    return [
        ["Sr. No.", "Erosion/Accretion", "Area (sq. km)", "Vulnerable stretch in km"],
        ["1", "Land loss during to erosion", "0.02", "2.01"],
        ["2", "Land formed due to accretion", "0.07", "5.05"]
    ]
    
    
def getVulnerablePopulationTableData(village_id):
    try:
        # Get all aggregations in single query
        data = HouseholdSurvey.objects.filter(village=village_id).aggregate(
            children=Sum('children_below_6_years'),
            seniors=Sum('senior_citizens'),
            pregnant=Sum('pregnant_women'),
            lactating=Sum('lactating_women'),
            disabled=Sum('persons_with_disability_or_chronic_disease'),
            males=Sum('number_of_males_including_children'),
            females=Sum('number_of_females_including_children')
        )
        
        children = data['children'] or 0
        seniors = data['seniors'] or 0
        pregnant = data['pregnant'] or 0
        lactating = data['lactating'] or 0
        disabled = data['disabled'] or 0
        
        total_vulnerable = children + seniors + pregnant + lactating + disabled
        total_pop = (data['males'] or 0) + (data['females'] or 0)
        
        # Calculate percentages
        children_pct = f"{round(children/total_pop*100)}%" if total_pop > 0 else "0%"
        seniors_pct = f"{round(seniors/total_pop*100)}%" if total_pop > 0 else "0%"
        pregnant_pct = f"{round(pregnant/total_pop*100)}%" if total_pop > 0 else "0%"
        lactating_pct = f"{round(lactating/total_pop*100)}%" if total_pop > 0 else "0%"
        disabled_pct = f"{round(disabled/total_pop*100)}%" if total_pop > 0 else "0%"
        vulnerable_pct = f"{round(total_vulnerable/total_pop*100)}%" if total_pop > 0 else "0%"
        
        return [
            ["Sr. No.", "Vulnerable population", "Number", "Percentage"],
            ["1", "Children age < 6 years", str(children), children_pct],
            ["2", "People age > 60 years", str(seniors), seniors_pct],
            ["3", "Pregnant women", str(pregnant), pregnant_pct],
            ["4", "Lactating mother", str(lactating), lactating_pct],
            ["5", "Permanently disabled or chronic disease", str(disabled), disabled_pct],
            ["6", "Total vulnerable population", f"{total_vulnerable:,}", vulnerable_pct],
            ["7", "Total population", f"{total_pop:,}", ""]
        ]
    except Exception:
        return [
            ["Sr. No.", "Vulnerable population", "Number", "Percentage"],
            ["1", "Children age < 6 years", "425", "10%"],
            ["2", "People age > 60 years", "290", "7%"],
            ["3", "Pregnant women", "49", "1%"],
            ["4", "Lactating mother", "273", "6%"],
            ["5", "Permanently disabled or chronic disease", "75", "2%"],
            ["6", "Total vulnerable population", "1,112", "26%"],
            ["7", "Total population", "4,325", ""]
        ]

def getHousingData(village_id):
    try:
       
        
        # Get all counts in single query using conditional aggregation
        data = HouseholdSurvey.objects.filter(village=village_id).aggregate(
            flood_severe=Count('id', filter=Q(flood_class__gte=1.0)),
            flood_high=Count('id', filter=Q(flood_class__gte=0.5) & Q(flood_class__lt=1.0)),
            flood_medium=Count('id', filter=Q(flood_class__gte=0.3) & Q(flood_class__lt=0.5)),
            flood_low=Count('id', filter=Q(flood_class__lt=0.3)),
            erosion_severe=Count('id', filter=Q(erosion_class='50')),
            erosion_high=Count('id', filter=Q(erosion_class='100')),
            erosion_medium=Count('id', filter=Q(erosion_class='150')),
            erosion_low=Count('id', filter=Q(erosion_class='Above 150'))
        )
        
        flood_severe = data['flood_severe']
        flood_high = data['flood_high']
        flood_medium = data['flood_medium']
        flood_low = data['flood_low']
        
        erosion_severe = data['erosion_severe']
        erosion_high = data['erosion_high']
        erosion_medium = data['erosion_medium']
        erosion_low = data['erosion_low']
        
        total_flood = flood_severe + flood_high + flood_medium + flood_low
        total_erosion = erosion_severe + erosion_high + erosion_medium + erosion_low
        
        # Calculate percentages
        flood_severe_pct = round(flood_severe/total_flood*100) if total_flood > 0 else 0
        flood_high_pct = round(flood_high/total_flood*100) if total_flood > 0 else 0
        flood_medium_pct = round(flood_medium/total_flood*100) if total_flood > 0 else 0
        flood_low_pct = round(flood_low/total_flood*100) if total_flood > 0 else 0
        
        erosion_severe_pct = round(erosion_severe/total_erosion*100) if total_erosion > 0 else 0
        erosion_high_pct = round(erosion_high/total_erosion*100) if total_erosion > 0 else 0
        erosion_medium_pct = round(erosion_medium/total_erosion*100) if total_erosion > 0 else 0
        erosion_low_pct = round(erosion_low/total_erosion*100) if total_erosion > 0 else 0
        
        table_data = [
            ["Sr. No.", "Vulnerability level", "Flood", "", "Erosion", ""],
            ["", "", "Number of HH", "%", "Number of HH", "%"],
            ["1", "Severe", str(flood_severe), f"{flood_severe_pct}%" if flood_severe > 0 else "", str(erosion_severe), f"{erosion_severe_pct}%" if erosion_severe > 0 else ""],
            ["2", "High", str(flood_high), f"{flood_high_pct}%" if flood_high > 0 else "", str(erosion_high), f"{erosion_high_pct}%" if erosion_high > 0 else ""],
            ["3", "Medium", str(flood_medium), f"{flood_medium_pct}%" if flood_medium > 0 else "", str(erosion_medium), f"{erosion_medium_pct}%" if erosion_medium > 0 else ""],
            ["4", "Low", str(flood_low), f"{flood_low_pct}%" if flood_low > 0 else "", str(erosion_low), f"{erosion_low_pct}%" if erosion_low > 0 else ""]
        ]
        
        summary = {
            'flood_max_pct': max([flood_severe_pct, flood_high_pct, flood_medium_pct, flood_low_pct]),
            'erosion_max_pct': max([erosion_severe_pct, erosion_high_pct, erosion_medium_pct, erosion_low_pct])
        }
        
        return table_data, summary
    except Exception:
        table_data = [
            ["Sr. No.", "Vulnerability level", "Flood", "", "Erosion", ""],
            ["", "", "Number of HH", "%", "Number of HH", "%"],
            ["1", "Severe", "533", "54%", "86", "9%"],
            ["2", "High", "397", "40%", "114", "12%"],
            ["3", "Medium", "54", "5%", "75", "8%"],
            ["4", "Low", "0", "0%", "709", "72%"]
        ]
        
        summary = {'flood_max_pct': 54, 'erosion_max_pct': 72}
        
        return table_data, summary

def getHouseTypeData(village_id):
    try:
        data = HouseholdSurvey.objects.filter(village=village_id).aggregate(
            kachcha=Count('id', filter=Q(house_type__icontains='Kachcha')),
            semi_pucca=Count('id', filter=Q(house_type__icontains='Semi pucca')),
            pucca=Count('id', filter=Q(house_type__icontains='Pucca'))
        )
        
        kachcha = data['kachcha']
        semi_pucca = data['semi_pucca']
        pucca = data['pucca']
        total = kachcha + semi_pucca + pucca
        
        kachcha_pct = f"{round(kachcha/total*100, 2)}%" if total > 0 else "0%"
        semi_pucca_pct = f"{round(semi_pucca/total*100, 2)}%" if total > 0 else "0%"
        pucca_pct = f"{round(pucca/total*100, 2)}%" if total > 0 else "0%"
        
        return [
            ["Sr. No.", "Typology", "Kachcha", "Semi Pucca", "Pucca", "Total"],
            ["1", "No of Household", str(kachcha), str(semi_pucca), str(pucca), f"{total:,}"],
            ["2", "%", kachcha_pct, semi_pucca_pct, pucca_pct, ""]
        ]
    except Exception:
        return [
            ["Sr. No.", "Typology", "Kachcha", "Semi Pucca", "Pucca", "Total"],
            ["1", "No of Household", "875", "148", "3", "1,026"],
            ["2", "%", "85.28%", "14.42%", "0.29%", ""]
        ]

def getBuildingQualityData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id).values_list('building_quality', flat=True)
        
        good_count = 0
        bad_count = 0
        moderate_count = 0
        
        for quality in households:
            if quality:
                quality_lower = quality.lower()
                if 'good' in quality_lower:
                    good_count += 1
                elif 'bad' in quality_lower:
                    bad_count += 1
                elif 'moderate' in quality_lower:
                    moderate_count += 1
        
        total = good_count + bad_count + moderate_count
        
        good_pct = f"{round(good_count/total*100)}%" if total > 0 else "0%"
        bad_pct = f"{round(bad_count/total*100)}%" if total > 0 else "0%"
        moderate_pct = f"{round(moderate_count/total*100)}%" if total > 0 else "0%"
        
        return [
            ["Sr. No.", "Building quality", "Number of HH", "%"],
            ["1", "Bad", str(bad_count), bad_pct],
            ["2", "Moderate", str(moderate_count), moderate_pct],
            ["3", "Good", str(good_count), good_pct]
        ]
    except Exception:
        return [
            ["Sr. No.", "Building quality", "Number of HH", "%"],
            ["1", "Bad", "145", "14%"],
            ["2", "Good", "170", "17%"]
        ]

def getPlinthHeightData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id).values_list('plinth_or_stilt_height_ft', flat=True)
        
        no_plinth = 0
        height_0_5 = 0
        height_1 = 0
        height_2 = 0
        height_3 = 0
        
        for height in households:
            if height:
                try:
                    height_val = float(height)
                    if height_val == 0:
                        no_plinth += 1
                    elif 0 < height_val <= 0.5:
                        height_0_5 += 1
                    elif height_val == 1.0:
                        height_1 += 1
                    elif height_val == 2.0:
                        height_2 += 1
                    elif height_val == 3.0:
                        height_3 += 1
                except ValueError:
                    if 'no' in height.lower() or 'nil' in height.lower():
                        no_plinth += 1
        
        total = no_plinth + height_0_5 + height_1 + height_2 + height_3
        
        no_plinth_pct = f"{round(no_plinth/total*100)}%" if total > 0 else "0%"
        height_0_5_pct = f"{round(height_0_5/total*100)}%" if total > 0 else "0%"
        height_1_pct = f"{round(height_1/total*100)}%" if total > 0 else "0%"
        height_2_pct = f"{round(height_2/total*100)}%" if total > 0 else "0%"
        height_3_pct = f"{round(height_3/total*100)}%" if total > 0 else "0%"
        
        return [
            ["Sr. No.", "Plinth height", "Number of Household", "Percentage"],
            ["1", "No plinth", str(no_plinth), no_plinth_pct],
            ["2", "0 - 0.5 feet", str(height_0_5), height_0_5_pct],
            ["3", "1.0 feet", str(height_1), height_1_pct],
            ["4", "2.0 feet", str(height_2), height_2_pct],
            ["5", "3.0 feet", str(height_3), height_3_pct],
            ["6", "Total", f"{total:,}", "100%"]
        ]
    except Exception:
        return [
            ["Sr. No.", "Plinth height", "Number of Household", "Percentage"],
            ["1", "No plinth", "66", "7%"],
            ["2", "0 - 0.5 feet", "217", "22%"],
            ["3", "1.0 feet", "560", "57%"],
            ["4", "2.0 feet", "139", "14%"],
            ["5", "3.0 feet", "2", "0%"],
            ["6", "Total", "984", "100%"]
        ]

def getToiletStructuralQualityData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id)
        
        pucca_count = 0
        kachcha_count = 0
        
        for household in households:
            sanitation_type = getattr(household, 'Sanitation_Type', None)
            if sanitation_type == 'Pucca':
                pucca_count += 1
            elif sanitation_type == 'Kachcha':
                kachcha_count += 1
        
        total = pucca_count + kachcha_count
        
        pucca_pct = f"{round(pucca_count/total*100)}%" if total > 0 else "0%"
        kachcha_pct = f"{round(kachcha_count/total*100)}%" if total > 0 else "0%"
        
        return [
            ["Sr. No.", "Toilet type", "Number", "Percentage"],
            ["1", "Pucca", str(pucca_count), pucca_pct],
            ["2", "Kachcha", str(kachcha_count), kachcha_pct],
            ["3", "Total", f"{total:,}", "100%"]
        ]
    except Exception:
        return [
            ["Sr. No.", "Toilet type", "Number", "Percentage"],
            ["1", "Pucca", "170", "17%"],
            ["2", "Kachcha", "814", "83%"],
            ["3", "Total", "984", "100%"]
        ]

def getHouseRepairExpenseData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id).values_list('expense_on_house_repair', flat=True)
        
        no_loss = 0
        upto_5000 = 0
        range_5000_15000 = 0
        range_15000_25000 = 0
        above_25000 = 0
        
        for expense in households:
            if expense:
                expense_str = str(expense)
                if expense_str == 'Upto 5K':
                    upto_5000 += 1
                elif expense_str == 'Upto 15K':
                    range_5000_15000 += 1
                elif expense_str == 'Upto 25K':
                    range_15000_25000 += 1
                elif expense_str == 'Morethan 25K':
                    above_25000 += 1
                else:
                    no_loss += 1
        
        total = no_loss + upto_5000 + range_5000_15000 + range_15000_25000 + above_25000
        
        return [
            ["Sr. No.", "Amount spend (INR)", "Number", "Percentage"],
            ["1", "No Loss", str(no_loss), f"{round(no_loss/total*100)}%" if total > 0 and no_loss > 0 else ""],
            ["2", "Upto 5,000", str(upto_5000), f"{round(upto_5000/total*100)}%" if total > 0 and upto_5000 > 0 else ""],
            ["3", "5,000 - 15,000", str(range_5000_15000), f"{round(range_5000_15000/total*100)}%" if total > 0 and range_5000_15000 > 0 else ""],
            ["4", "15,000 - 25,000", str(range_15000_25000), f"{round(range_15000_25000/total*100)}%" if total > 0 and range_15000_25000 > 0 else ""],
            ["5", "> 25,000", str(above_25000), f"{round(above_25000/total*100)}%" if total > 0 and above_25000 > 0 else ""]
        ]
    except Exception:
        return [
            ["Sr. No.", "Amount spend (INR)", "Number", "Percentage"],
            ["1", "No Loss", "75", "8%"],
            ["2", "Upto 5,000", "168", "17%"],
            ["3", "5,000 - 15,000", "541", "55%"],
            ["4", "15,000 - 25,000", "95", "10%"],
            ["5", "> 25,000", "105", "11%"]
        ]

def getHouseholdFloodLossData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id).values_list('economic_loss_hh', flat=True)
        
        no_loss = 0
        upto_5000 = 0
        range_5000_15000 = 0
        range_15000_25000 = 0
        above_25000 = 0
        
        for loss in households:
            if loss:
                loss_str = str(loss)
                if loss_str == 'Upto 5K':
                    upto_5000 += 1
                elif loss_str == 'Upto 15K':
                    range_5000_15000 += 1
                elif loss_str == 'Upto 25K':
                    range_15000_25000 += 1
                elif loss_str == 'Morethan 25K':
                    above_25000 += 1
                else:
                    no_loss += 1
        
        total = no_loss + upto_5000 + range_5000_15000 + range_15000_25000 + above_25000
        
        return [
            ["Sr. No.", "Loss amount (INR)", "Number of house", "Percentage"],
            ["1", "No Loss", str(no_loss), f"{round(no_loss/total*100)}%" if total > 0 and no_loss > 0 else ""],
            ["2", "Upto 5,000", str(upto_5000), f"{round(upto_5000/total*100)}%" if total > 0 and upto_5000 > 0 else ""],
            ["3", "5,000 - 15,000", str(range_5000_15000), f"{round(range_5000_15000/total*100)}%" if total > 0 and range_5000_15000 > 0 else ""],
            ["4", "15,000 - 25,000", str(range_15000_25000), f"{round(range_15000_25000/total*100)}%" if total > 0 and range_15000_25000 > 0 else ""],
            ["5", "> 25,000", str(above_25000), f"{round(above_25000/total*100)}%" if total > 0 and above_25000 > 0 else ""]
        ]
    except Exception:
        return [
            ["Sr. No.", "Loss amount (INR)", "Number of house", "Percentage"],
            ["1", "No Loss", "3", "0%"],
            ["2", "Upto 5,000", "141", "14%"],
            ["3", "5,000 - 15,000", "538", "55%"],
            ["4", "15,000 - 25,000", "123", "13%"],
            ["5", "> 25,000", "179", "18%"]
        ]

def getAgricultureFloodLossData(village_id):
    try:
        households = HouseholdSurvey.objects.filter(village=village_id).values_list('loss_agricultire_livlihood', flat=True)
        
        no_loss = 0
        upto_5000 = 0
        range_5000_15000 = 0
        range_15000_25000 = 0
        above_25000 = 0
        
        for loss in households:
            if loss:
                loss_str = str(loss)
                if loss_str == 'Upto 5K':
                    upto_5000 += 1
                elif loss_str == 'Upto 15K':
                    range_5000_15000 += 1
                elif loss_str == 'Upto 25K':
                    range_15000_25000 += 1
                elif loss_str == 'Morethan 25K':
                    above_25000 += 1
                else:
                    no_loss += 1
        
        total = no_loss + upto_5000 + range_5000_15000 + range_15000_25000 + above_25000
        
        return [
            ["Sr. No.", "Loss amount (INR)", "Number of house", "Percentage"],
            ["1", "No Loss", str(no_loss), f"{round(no_loss/total*100)}%" if total > 0 and no_loss > 0 else ""],
            ["2", "Upto 5,000", str(upto_5000), f"{round(upto_5000/total*100)}%" if total > 0 and upto_5000 > 0 else ""],
            ["3", "5,000 - 15,000", str(range_5000_15000), f"{round(range_5000_15000/total*100)}%" if total > 0 and range_5000_15000 > 0 else ""],
            ["4", "15,000 - 25,000", str(range_15000_25000), f"{round(range_15000_25000/total*100)}%" if total > 0 and range_15000_25000 > 0 else ""],
            ["5", "> 25,000", str(above_25000), f"{round(above_25000/total*100)}%" if total > 0 and above_25000 > 0 else ""]
        ]
    except Exception:
        return [
            ["Sr. No.", "Loss amount (INR)", "Number of house", "Percentage"],
            ["1", "No Loss", "364", "37%"],
            ["2", "Upto 5,000", "166", "17%"],
            ["3", "5,000 - 15,000", "267", "27%"],
            ["4", "15,000 - 25,000", "78", "8%"],
            ["5", "> 25,000", "109", "11%"]
        ]

def getRoadFloodVulnerabilityData(village_id):
    try:
        
        
        roads = VillageRoadInfo.objects.filter(village=village_id)
        
        road_data = {}
        for road in roads:
            road_type = f"{road.road_constructed_by} ({road.road_surface_type})"
            if road_type not in road_data:
                road_data[road_type] = {
                    'total_length': 0,
                    'severe': 0,
                    'high': 0, 
                    'moderate': 0,
                    'low': 0
                }
            
            length_km = road.road_length_m / 1000
            road_data[road_type]['total_length'] += length_km
            
            flood_class = str(road.flood_class)
            if flood_class == '>1.0 m':
                road_data[road_type]['severe'] += length_km
            elif flood_class == '0.5 - 1.0 m':
                road_data[road_type]['high'] += length_km
            elif flood_class == '0.3 - 0.5 m':
                road_data[road_type]['moderate'] += length_km
            elif flood_class == '0.3 m':
                road_data[road_type]['low'] += length_km
        
        table_data = [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Road Type", bold_center_style), Paragraph("Length in km", bold_center_style), Paragraph("Flood vulnerability", bold_center_style)],
            [Paragraph("", bold_center_style), Paragraph("", bold_center_style), Paragraph("", bold_center_style), Paragraph("Severe (>1.0 m)", bold_center_style), Paragraph("High (0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate (0.3 – 0.5 m)", bold_center_style), Paragraph("Low (<0.3 m)", bold_center_style)],
        ]
        
        sr_no = 1
        total_length = 0
        total_severe = 0
        total_high = 0
        total_moderate = 0
        total_low = 0
        
        for road_type, data in road_data.items():
            table_data.append([
                str(sr_no),
                Paragraph(road_type, normal_style),
                f"{data['total_length']:.2f}",
                f"{data['severe']:.2f}",
                f"{data['high']:.2f}",
                f"{data['moderate']:.2f}",
                f"{data['low']:.2f}"
            ])
            sr_no += 1
            total_length += data['total_length']
            total_severe += data['severe']
            total_high += data['high']
            total_moderate += data['moderate']
            total_low += data['low']
        
        table_data.append([
            "", "Total", f"{total_length:.2f}", f"{total_severe:.2f}", f"{total_high:.2f}", f"{total_moderate:.2f}", f"{total_low:.2f}"
        ])
        
        return table_data
        
    except Exception:
        return [
            ["Sr. No.", "Road Type","Length in km", "Flood vulnerability"],
            ["","","","", "Severe (>1.0 m)", "High (0.5 – 1.0 m)", "Moderate (0.3 – 0.5 m)", "Low (<0.3 m)"],
            ["1", Paragraph("PNRD (Cement block road)", normal_style), "4.35", "2.71", "1.62", "0.01", "0.00"],
            ["2", Paragraph("PNRD (Concrete road)", normal_style), "2.39", "0.81", "1.36", "0.03", "0.18"],
            ["3", Paragraph("PNRD (Earthen road)", normal_style), "4.53", "2.90", "1.52", "0.00", "0.10"],
            ["4", Paragraph("PWD (Bituminous road)", normal_style), "3.49", "2.16", "0.78", "0.00", "0.55"],
            ["5", Paragraph("WRD (Earthen road)", normal_style), "1.06", "0.18", "0.86", "0.00", "0.02"],
            ["5", "Total", "15.82", "8.77", "6.15", "0.05", "0.85"]
        ]

def getRoadErosionVulnerabilityData(village_id):
    try:
        roads = VillageRoadInfoErosion.objects.filter(village=village_id)
        
        road_data = {}
        for road in roads:
            road_type = f"{road.road_constructed_by} ({road.road_surface_type})"
            if road_type not in road_data:
                road_data[road_type] = {
                    'total_length': 0,
                    'severe': 0,
                    'high': 0,
                    'moderate': 0,
                    'low': 0
                }
            
            length_km = road.road_length_m / 1000
            road_data[road_type]['total_length'] += length_km
            
            erosion_class = str(road.erosion_class)
            if erosion_class == '50':
                road_data[road_type]['severe'] += length_km
            elif erosion_class == '100':
                road_data[road_type]['high'] += length_km
            elif erosion_class == '150':
                road_data[road_type]['moderate'] += length_km
            else:
                road_data[road_type]['low'] += length_km
        
        table_data = [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Road Type", bold_center_style), Paragraph("Length in km", bold_center_style), Paragraph("Erosion vulnerability", bold_center_style)],
            [Paragraph("", bold_center_style), Paragraph("", bold_center_style), Paragraph("", bold_center_style), Paragraph("Severe (<50 m)", bold_center_style), Paragraph("High (50 – 100 m)", bold_center_style), Paragraph("Moderate (100 – 150 m)", bold_center_style), Paragraph("Low (>150 m)", bold_center_style)],
        ]
        
        sr_no = 1
        total_length = 0
        total_severe = 0
        total_high = 0
        total_moderate = 0
        total_low = 0
        
        for road_type, data in road_data.items():
            table_data.append([
                str(sr_no),
                Paragraph(road_type, normal_style),
                f"{data['total_length']:.2f}",
                f"{data['severe']:.2f}",
                f"{data['high']:.2f}",
                f"{data['moderate']:.2f}",
                f"{data['low']:.2f}"
            ])
            sr_no += 1
            total_length += data['total_length']
            total_severe += data['severe']
            total_high += data['high']
            total_moderate += data['moderate']
            total_low += data['low']
        
        table_data.append([
            "", "Total", f"{total_length:.2f}", f"{total_severe:.2f}", f"{total_high:.2f}", f"{total_moderate:.2f}", f"{total_low:.2f}"
        ])
        
        return table_data
        
    except Exception:
        return [
            ["Sr. No.", "Road Type", "Length in km", "Erosion vulnerability "  ],
            ["","","","Severe (<50 m)", "High (50 – 100 m)", "Moderate (100 – 150 m)", "Low (>150 m)"],
            ["1", Paragraph("PNRD (Cement block road)", normal_style), "4.35", "0.03", "0.17", "0.40", "3.75"],
            ["2", Paragraph("PNRD (Concrete road)", normal_style), "2.39", "1.13", "0.85", "0.36", "0.06"],
            ["3", Paragraph("PNRD (Earthen road)", normal_style), "4.53", "0.23", "0.38", "0.29", "3.64"],
            ["4", Paragraph("PWD (Bituminous road)", normal_style), "3.49", "0.00", "0.00", "0.00", "3.49"],
            ["5", Paragraph("WRD (Earthen road)", normal_style), "1.06", "1.01", "0.04", "0.00", "0.00"],
            ["5", "Total", "15.82", "2.40", "1.44", "1.05", "10.94"]
        ]






def getEducationalFacilitiesData(village_id):
    try:
       
        
        facilities = Critical_Facility.objects.filter(village=village_id)
        
        # Initialize counters
        anganwadi_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        lp_school_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        middle_school_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        madarsa_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        
        for facility in facilities:
            name = (facility.name_of_building or '').lower()
            occupancy = (facility.occupancy_type or '').lower()
            
            # Determine facility type
            if 'anganwadi' in name or 'anganwadi' in occupancy:
                data = anganwadi_data
            elif any(x in name for x in ['l p school', 'l.p. school', 'lp school']) and 'school' in occupancy:
                data = lp_school_data
            elif 'madrassa' in name and 'school' in occupancy:
                data = madarsa_data
            elif 'school' in occupancy and 'madrassa' not in name:
                data = middle_school_data
            else:
                continue
                
            data['total'] += 1
            
            # Flood vulnerability based on flood_class
            flood_class = facility.flood_class or ''
            if flood_class == '>1.0 M':
                data['flood_severe'] += 1
            elif flood_class == '0.5 - 1.0 M':
                data['flood_high'] += 1
            elif flood_class == '0.3 - 0.5 M':
                data['flood_moderate'] += 1
            elif flood_class == '0.3 M':
                data['flood_low'] += 1
                
            # Erosion vulnerability based on erosion_class
            erosion_class = facility.erosion_class or ''
            if erosion_class == '50':
                data['erosion_severe'] += 1
            elif erosion_class == '100':
                data['erosion_high'] += 1
            elif erosion_class == '150':
                data['erosion_moderate'] += 1
            elif erosion_class in ['Above 150', '>150']:
                data['erosion_low'] += 1
        
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", "Anganwadi", str(anganwadi_data['total']), str(anganwadi_data['flood_severe']), str(anganwadi_data['flood_high']), str(anganwadi_data['flood_moderate']), str(anganwadi_data['flood_low']), str(anganwadi_data['erosion_severe']), str(anganwadi_data['erosion_high']), str(anganwadi_data['erosion_moderate']), str(anganwadi_data['erosion_low'])],
            ["2", "LP School", str(lp_school_data['total']), str(lp_school_data['flood_severe']), str(lp_school_data['flood_high']), str(lp_school_data['flood_moderate']), str(lp_school_data['flood_low']), str(lp_school_data['erosion_severe']), str(lp_school_data['erosion_high']), str(lp_school_data['erosion_moderate']), str(lp_school_data['erosion_low'])],
            ["3", "Middle School", str(middle_school_data['total']), str(middle_school_data['flood_severe']), str(middle_school_data['flood_high']), str(middle_school_data['flood_moderate']), str(middle_school_data['flood_low']), str(middle_school_data['erosion_severe']), str(middle_school_data['erosion_high']), str(middle_school_data['erosion_moderate']), str(middle_school_data['erosion_low'])],
            ["4", "Madarsa", str(madarsa_data['total']), str(madarsa_data['flood_severe']), str(madarsa_data['flood_high']), str(madarsa_data['flood_moderate']), str(madarsa_data['flood_low']), str(madarsa_data['erosion_severe']), str(madarsa_data['erosion_high']), str(madarsa_data['erosion_moderate']), str(madarsa_data['erosion_low'])]
        ]
        
    except Exception:
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", "Anganwadi", "2", "1", "1", "0", "0", "0", "0", "0", "2"],
            ["2", "LP School", "1", "0", "1", "0", "0", "0", "0", "0", "1"],
            ["3", "Middle School", "1", "1", "0", "0", "0", "0", "1", "0", "1"],
            ["4", "Madarsa", "0", "0", "0", "0", "0", "0", "0", "0", "0"]
        ]

def getOtherAssetsData(village_id):
    try:
        from vdmp_dashboard.models import Critical_Facility
        
        facilities = Critical_Facility.objects.filter(village=village_id)
        
        # Initialize counters
        religious_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        others_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        
        for facility in facilities:
            occupancy = (facility.occupancy_type or '').lower()
            
            # Determine facility type
            if 'religious place' in occupancy:
                data = religious_data
            elif 'others' in occupancy:
                data = others_data
            else:
                continue
                
            data['total'] += 1
            
            # Flood vulnerability based on flood_class
            flood_class = facility.flood_class or ''
            if flood_class == '>1.0 M':
                data['flood_severe'] += 1
            elif flood_class == '0.5 - 1.0 M':
                data['flood_high'] += 1
            elif flood_class == '0.3 - 0.5 M':
                data['flood_moderate'] += 1
            elif flood_class == '0.3 M':
                data['flood_low'] += 1
                
            # Erosion vulnerability based on erosion_class
            erosion_class = facility.erosion_class or ''
            if erosion_class == '50':
                data['erosion_severe'] += 1
            elif erosion_class == '100':
                data['erosion_high'] += 1
            elif erosion_class == '150':
                data['erosion_moderate'] += 1
            elif erosion_class in ['Above 150', '>150']:
                data['erosion_low'] += 1
        
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", "Religious place", str(religious_data['total']), str(religious_data['flood_severe']), str(religious_data['flood_high']), str(religious_data['flood_moderate']), str(religious_data['flood_low']), str(religious_data['erosion_severe']), str(religious_data['erosion_high']), str(religious_data['erosion_moderate']), str(religious_data['erosion_low'])],
            ["2", "Others", str(others_data['total']), str(others_data['flood_severe']), str(others_data['flood_high']), str(others_data['flood_moderate']), str(others_data['flood_low']), str(others_data['erosion_severe']), str(others_data['erosion_high']), str(others_data['erosion_moderate']), str(others_data['erosion_low'])]
        ]
        
    except Exception:
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", "Religious place", "5", "5", "0", "0", "0", "0", "0", "0", "5"],
            ["2", "Others", "2", "1", "1", "0", "0", "0", "0", "0", "2"]
        ]

def getPowerInfrastructureData(village_id):
    try:
       
        
        # Get village code
        village = tblVillage.objects.get(id=village_id)
        village_code = village.code
        
        # Initialize data
        electric_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        transformer_data = {'total': 0, 'flood_severe': 0, 'flood_high': 0, 'flood_moderate': 0, 'flood_low': 0, 'erosion_severe': 0, 'erosion_high': 0, 'erosion_moderate': 0, 'erosion_low': 0}
        
        # Get total count from geoserver for electric poles
        wfs_url = "http://10.2.114.150:8085/geoserver/assam/ows"
        params = {
            "service": "WFS",
            "version": "1.0.0",
            "request": "GetFeature",
            "typeName": "assam:electricpoles",
            "outputFormat": "application/json",
            "CQL_FILTER": f"vill_id='{village_code}'"
        }
        
        response = requests.get(wfs_url, params=params)
        if response.status_code == 200:
            geojson = response.json()
            electric_data['total'] = len(geojson.get("features", []))
        
        # Get total count from geoserver for transformers
        params["typeName"] = "assam:transformer"
        response = requests.get(wfs_url, params=params)
        if response.status_code == 200:
            geojson = response.json()
            transformer_data['total'] = len(geojson.get("features", []))
        
        # Get vulnerability data from database models
        electric_poles = ElectricPole.objects.filter(village=village_id)
        for pole in electric_poles:
            # Flood vulnerability
            flood_class = pole.flood_class or ''
            if flood_class == '>1.0 M':
                electric_data['flood_severe'] += 1
            elif flood_class == '0.5 - 1.0 M':
                electric_data['flood_high'] += 1
            elif flood_class == '0.3 - 0.5 M':
                electric_data['flood_moderate'] += 1
            elif flood_class == '0.3 M':
                electric_data['flood_low'] += 1
                
            # Erosion vulnerability
            erosion_class = pole.erosion_class or ''
            if erosion_class == '50':
                electric_data['erosion_severe'] += 1
            elif erosion_class == '100':
                electric_data['erosion_high'] += 1
            elif erosion_class == '150':
                electric_data['erosion_moderate'] += 1
            elif erosion_class in ['Above 150', '>150']:
                electric_data['erosion_low'] += 1
        
        transformers = Transformer.objects.filter(village=village_id)
        for transformer in transformers:
            # Flood vulnerability
            flood_class = transformer.flood_class or ''
            if flood_class == '>1.0 M':
                transformer_data['flood_severe'] += 1
            elif flood_class == '0.5 - 1.0 M':
                transformer_data['flood_high'] += 1
            elif flood_class == '0.3 - 0.5 M':
                transformer_data['flood_moderate'] += 1
            elif flood_class == '0.3 M':
                transformer_data['flood_low'] += 1
                
            # Erosion vulnerability
            erosion_class = transformer.erosion_class or ''
            if erosion_class == '50':
                transformer_data['erosion_severe'] += 1
            elif erosion_class == '100':
                transformer_data['erosion_high'] += 1
            elif erosion_class == '150':
                transformer_data['erosion_moderate'] += 1
            elif erosion_class in ['Above 150', '>150']:
                transformer_data['erosion_low'] += 1
        
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", Paragraph("Electric post and network", normal_style), str(electric_data['total']), str(electric_data['flood_severe']), str(electric_data['flood_high']), str(electric_data['flood_moderate']), str(electric_data['flood_low']), str(electric_data['erosion_severe']), str(electric_data['erosion_high']), str(electric_data['erosion_moderate']), str(electric_data['erosion_low'])],
            ["2", Paragraph("Transformer", normal_style), str(transformer_data['total']), str(transformer_data['flood_severe']), str(transformer_data['flood_high']), str(transformer_data['flood_moderate']), str(transformer_data['flood_low']), str(transformer_data['erosion_severe']), str(transformer_data['erosion_high']), str(transformer_data['erosion_moderate']), str(transformer_data['erosion_low'])]
        ]
        
    except Exception:
        return [
            [Paragraph("Sr. No.", bold_center_style), Paragraph("Type", bold_center_style), Paragraph("Number", bold_center_style), Paragraph("Flood vulnerability", bold_center_style), "", "", "", Paragraph("Erosion vulnerability", bold_center_style), "", "", ""],
            ["", "", "", Paragraph("Severe\n(>1.0 m)", bold_center_style), Paragraph("High\n(0.5 – 1.0 m)", bold_center_style), Paragraph("Moderate\n(0.3 – 0.5 m)", bold_center_style), Paragraph("Low\n(<0.3 m)", bold_center_style), Paragraph("Severe\n(<50 m)", bold_center_style), Paragraph("High\n(50 – 100 m)", bold_center_style), Paragraph("Moderate\n(100 – 150 m)", bold_center_style), Paragraph("Low\n(>150 m)", bold_center_style)],
            ["1", Paragraph("Electric post and network", normal_style), "376", "33", "292", "20", "31", "35", "39", "18", "284"],
            ["2", Paragraph("Transformer", normal_style), "5", "3", "2", "0", "0", "0", "1", "0", "4"]
        ]

def getLivelihoodExposureData(village_id):
    try:
        from village_profile.models import tblVillage
        village = tblVillage.objects.select_related('gram_panchayat__circle__district').get(id=village_id)
        village_name = village.name
        district_name = village.gram_panchayat.circle.district.name
        title = f"Livelihood Vulnerability Index-{village_name}, {district_name}, Assam"
    except:
        title = "Livelihood Vulnerability Index-Rupakuchi, Barpeta, Assam"
    
    return [
        [Paragraph(title, bold_center_style)],
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Indicator", bold_center_style), Paragraph("Explanation", bold_center_style), Paragraph("Vulnerability score", bold_center_style)],
        ["1", "Flood Frequency", "Floods occur more than once a year", "5"],
        ["2", "Severity of flood in HH", "79% HH with flood depth >0.5 m (20% means 1 score)", "4"],
        ["3", "Duration of standing flood water", "Flood water stays for > 7 days in the agricultural land", "5"],
        ["4", "Severity of erosion", "2.4 km of river under erosion", "4"],
        ["", "Total", "", "18"]
    ]

def getLivelihoodSensitivityData(village_id):
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Indicator", bold_center_style), Paragraph("Explanation", bold_center_style), Paragraph("Vulnerability score", bold_center_style)],
        ["1", Paragraph("Land ownership (% of no land)", normal_style), "32% HH have no agriculture land", "2"],
        ["2", Paragraph("Land size for agriculture", normal_style), "47% HH own agriculture land <1.5 bigha", "3"],
        ["3", Paragraph("Income dependency", normal_style), "33% HH have single source of income", "2"],
        ["4", Paragraph("Livelihood loss", normal_style), "72% HH experience crop loss due to flood", "4"],
        ["5", Paragraph("Road vulnerable to flood", normal_style), "83% of roads of highly vulnerable to flood", "5"],
        ["6", Paragraph("Road vulnerable to erosion", normal_style), "26% of roads of highly vulnerable to erosion", "2"],
        ["7", Paragraph("Access to market for input supplies", normal_style), "Access means 1 and no access 5", "1"],
        ["8", Paragraph("Access to market for output produce", normal_style), "Access means 1 and no access 5", "1"],
        ["9", Paragraph("Access to high quality seeds", normal_style), "Access means 1 and no access 5", "1"],
        ["10", Paragraph("Access to fair price input supplies", normal_style), "Access means 1 and no access 5", "1"],
        ["11", Paragraph("Access to high technology farming practices", normal_style), "Access means 1 and no access 5", "1"],
        ["12", Paragraph("Access to scientific methods of farming practices", normal_style), "Access means 1 and no access 5", "1"],
        ["13", Paragraph("Access to health service including vaccination", normal_style), "Access means 1 and no access 5", "1"],
        ["", "Total", "", "25"]
    ]

def getLivelihoodAdaptiveCapacityData(village_id):
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Indicator", bold_center_style), Paragraph("Explanation", bold_center_style), Paragraph("Vulnerability score", bold_center_style)],
        ["1", Paragraph("Agriculture Insurance", normal_style), "Every 20% 1 score", "1"],
        ["2", Paragraph("Livestock/fisheries Insurance", normal_style), "Every 20% 1 score", "1"],
        ["3", Paragraph("Sericulture Insurance", normal_style), "Every 20% 1 score", "1"],
        ["4", Paragraph("Weaving equipment insurance", normal_style), "Every 20% 1 score", "1"],
        ["5", Paragraph("Access to credit", normal_style), "Every 20% 1 score", "5"],
        ["6", Paragraph("Access to flood resilient seed", normal_style), "Every 20% 1 score", "5"],
        ["7", Paragraph("More than one crop a year", normal_style), "Every 20% 1 score", "5"],
        ["8", Paragraph("Diversity of crops", normal_style), "Every 20% 1 score", "3"],
        ["9", Paragraph("Access to technology and knowledge (KVK)", normal_style), "Access means 1 and no access means 5", "5"],
        ["", "Total", "", "27"]
    ]

def getEnvironmentalCharacteristicsData(village_id):
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Environmental characteristics", bold_center_style), Paragraph("Details", bold_center_style)],
        ["1", Paragraph("River bank-erosion", normal_style), "1.8 km"],
        ["2", Paragraph("Siltation", normal_style), "Low"],
        ["3", Paragraph("Water logging in paddy field", normal_style), "3 months"],
        ["4", Paragraph("Encroachment of wetlands", normal_style), "Low"],
        ["5", Paragraph("Modification of natural drains", normal_style), "Yes"]
    ]
    
    
def getFloodLossBuildingsTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Residential building", normal_style), "31.69", "2.24", "7%"],
        ["2", Paragraph("Commercial building", normal_style), "0.69", "0.04", "6%"],
        ["3", Paragraph("Essential facilities (school, religious places, madrasa, hospital, and govt. buildings)", normal_style), "1.33", "0.03", "2%"]
    ]

def getFloodLossRoadsAgriTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Roads - extreme flood event scenario 2022", normal_style), "3.28", "0.5", "15%"],
        ["2", Paragraph("Agriculture (Paddy) during monsoon season - extreme flood event 2022", normal_style), "0.78", "0.76", "97%"]
    ]

def getAverageLossRoadsAgriTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Roads", normal_style), "3.28", "0.4", "12%"],
        ["2", Paragraph("Agriculture (Paddy) during monsoon season", normal_style), "0.78", "0.61", "78%"]
    ]

def getEarthquakeLossBuildingsTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Residential building", normal_style), "31.69", "25.49", "80%"],
        ["2", Paragraph("Commercial building", normal_style), "0.69", "0.56", "81%"],
        ["3", Paragraph("Essential facilities (school, religious places, madrasa, hospital, and govt. buildings)", normal_style), "1.33", "0.67", "51%"]
    ]

def getCycloneLossBuildingsTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Residential building", normal_style), "31.69", "0.07", "0.2%"],
        ["2", Paragraph("Commercial building", normal_style), "0.69", "0.0018", "0.3%"],
        ["3", Paragraph("Essential facilities (school, religious places, madrasa, hospital, and govt. buildings)", normal_style), "1.33", "0.00044", "0.03%"]
    ]

def getStrongWindAgricultureTableData():
    return [
        [Paragraph("Sr. No.", bold_center_style), Paragraph("Exposure Category", bold_center_style), Paragraph("Total Exposure Value (INR Crore)", bold_center_style), Paragraph("Loss (INR Crore)", bold_center_style), Paragraph("Loss % wrt exposure value", bold_center_style)],
        ["1", Paragraph("Agriculture (Paddy)", normal_style), "0.25", "0.0006", "0.3%"]
    ]

def draw_hazard_Vulnerability_risk(elements,village_id):
    
    map_file_fields = VDMP_Maps_Data.objects.filter(village_id=village_id).values(
        'village_id',
        'distribution_of_building',
        'road_infrastructure',
        'landuse',
        'flood_erosion',
        'wind_hazard',
        'earthquake_hazard',
        'essential_facilities',
        'electrical_infrastructure'
    ).first()

    styles = getSampleStyleSheet()
    heading = Paragraph("<a name='hazard_risk'/><b>4 Hazard, Vulnerability and Risk Assessment </b>", blue_sub_heading)
    elements.append(heading)
    elements.append(Spacer(1, 12))

  

    heading = Paragraph("<b>4.1	Hazard Assessment</b>", blue_sub_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 1: Presence of hazards", table_sub_title) 
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getHazardPresenceData()
    table = create_styled_table(data, [40,110,110,100,140], False, True, srNoStyle, "Hazard Presence")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # ------------------ 4.1 --------------------
    heading = Paragraph("<b>4.1.1 Earthquake hazard </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    p=Paragraph("Assam is in earthquake zone V which signifies highest earthquake risk and is class IX in MMI intensity scale. ", styles['Normal'])
    elements.append(p)
    elements.append(Spacer(1, 6))
    data=getEarthquakeMMITableData()
    table = create_styled_table(data, [40,110, 110, 100, 140], False, True, srNoStyle, "Earthquake MMI")
    elements.append(table)
    elements.append(Spacer(1, 12))
    # Add image with 70% of page height
    
    image_height = page_height * 0.77

    #img from model if not available get from geoserver
    img_field = map_file_fields['earthquake_hazard'] if map_file_fields else None
    if img_field:
        # Get the full file path (works for local storage)
        img_path = f"{MEDIA_ROOT}/{img_field}"

        # Create a ReportLab Image object
        img = ReportLabImage(img_path, width=450, height=image_height)  # adjust size

        # Put the Image object inside a table
        img_table = ReportLabTable([[img]])
        img_table.setStyle(TableStyle([('BOX', (0, 0), (-1, -1), 1, colors.black)]))

        elements.append(img_table)

    else:
        layers = ['assam:village_boundary','assam:assam_pga','assam:village_boundary']
        img, actual_width, actual_height = get_geoserver_image_as_rl_image(
            layers, village_id=village_id, max_width=500
        )
        if img:
            # img is already a ReportLab Image object - use directly
            img_table = ReportLabTable([[img]])
            img_table.setStyle(TableStyle([('BOX', (0, 0), (-1, -1), 1, colors.black)]))
            elements.append(img_table)
    
    
    
    elements.append(Spacer(1, 12))
    sub_title=Paragraph("Figure 4 1: Earthquake hazard", image_title)
    elements.append(sub_title)
    
    # ------------------ 4.1.2 --------------------
    heading = Paragraph("<b>4.1.2	Strong wind hazard </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    # Strong wind bullet point
    wind_points = [
        "Wind speed ranges from 38 - 51 kmph – as per IMD classification this is strong to squally wind."
    ]
    
    wind_bullet_items = ListFlowable(
        [ListItem(Paragraph(text, styles["Normal"])) for text in wind_points],
        bulletType='bullet',
        start='•',
        leftIndent=20,
        bulletFontName='Helvetica',
        bulletFontSize=10
    )
    
    elements.append(wind_bullet_items)
    elements.append(Spacer(1, 12))
    
    p = Paragraph("Potential damage would be:", styles['Normal'])
    elements.append(p)
    elements.append(Spacer(1, 6))
    
    # Additional wind damage points
    damage_points = [
        "Small branches of trees may break and if fall on electric lines can damage electric network and small installation",
        "Difficulty for cyclists, motorcyclists, and high-profile vehicles (like vans or trucks) to maintain control",
        "No structural damage to buildings but temporary structures (like tents, signage, or scaffolding) may get damage",
        "This level of wind is not typically destructive but can cause minor to moderate localized damage, especially if prolonged or accompanied by rain."
    ]
    
    damage_bullet_items = ListFlowable(
        [ListItem(Paragraph(text, styles["Normal"])) for text in damage_points],
        bulletType='bullet',
        start='•',
        leftIndent=20,
        bulletFontName='Helvetica',
        bulletFontSize=10
    )
    
    elements.append(damage_bullet_items)
    elements.append(Spacer(1, 12))
    image_height = page_height * 0.77   

        #img from model if not available get from geoserver
    img_field = map_file_fields['wind_hazard'] if map_file_fields else None
    if img_field:
        # Get the full file path (works for local storage)
        img_path = f"{MEDIA_ROOT}/{img_field}"

        # Create a ReportLab Image object
        img = ReportLabImage(img_path, width=450, height=image_height)  # adjust size

        # Put the Image object inside a table
        img_table = ReportLabTable([[img]])
        img_table.setStyle(TableStyle([('BOX', (0, 0), (-1, -1), 1, colors.black)]))

        elements.append(img_table)

        
        elements.append(Spacer(1, 12))
        sub_title=Paragraph("Figure 4 2 Wind Hazard", image_title)
        elements.append(sub_title)

    elements.append(Spacer(1, 12))
    heading = Paragraph("<b>4.1.3	Flood hazard</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 2: Flood hazard characteristics", table_sub_title) 
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    table_data=getHazardCharacteristics(village_id)
    table = create_styled_table(table_data, [40, 230, 230], False, True, srNoStyle, "Flood Hazard Characteristics")
    elements.append(table)
    elements.append(Spacer(1, 6))
    
    image_height = page_height * 0.79

    #new img added for flood hazard
    img_field = map_file_fields['flood_erosion'] if map_file_fields else None
    if img_field:
        # Get the full file path (works for local storage)
        img_path = f"{MEDIA_ROOT}/{img_field}"

        # Create a ReportLab Image object
        img = ReportLabImage(img_path, width=450, height=image_height)  # adjust size

        # Put the Image object inside a table
        img_table = ReportLabTable([[img]])
        img_table.setStyle(TableStyle([('BOX', (0, 0), (-1, -1), 1, colors.black)]))

        elements.append(img_table)

        elements.append(Spacer(1, 12))
        sub_title=Paragraph("Figure 4 3: Flood Hazard", image_title)
        elements.append(sub_title)
    
    elements.append(Spacer(1, 6))

    sub_title=Paragraph("Table 4 3: Hazard calendar", table_sub_title) 
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    calendar_data=getHazardCalender(village_id)
    custom_styles = [
        # General header styles
        ('ALIGN', (0, 1), (0, -1), 'RIGHT'),
        ('FONTNAME', (0, 1), (0, -1), 'Helvetica-Bold'),
        ('SPAN', (2, 0), (-1, 0)),
        ('ALIGN', (2, 0), (-1, 0), 'CENTER'),
        ('SPAN', (0, 0), (0, 1)),
        ('SPAN', (1, 0), (1, 1)),
        ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor("#c6d9f1")),  # Header row
        ('BACKGROUND', (0, 1), (-1, 1), colors.HexColor("#c6d9f1")),  # Months row

        # Earthquake
        ('SPAN', (2, -1), (-1, -1)),
        ('BACKGROUND', (2, -1), (-1, -1), colors.HexColor("#eb2b2b")),
        ('ALIGN', (2, -1), (-1, -1), 'CENTER'),

        # Temperature
        ('SPAN', (2, 2), (3, 2)),
        ('BACKGROUND', (2, 2), (3, 2), colors.HexColor("#f9cb9c")),
        ('ALIGN', (2, 2), (3, 2), 'CENTER'),

        ('SPAN', (4, 2), (4, 2)),
        ('BACKGROUND', (4, 2), (4, 2), colors.HexColor("#f6b26b")),

        ('SPAN', (5, 2), (8, 2)),
        ('BACKGROUND', (5, 2), (8, 2), colors.HexColor("#e69138")),
        ('ALIGN', (5, 2), (8, 2), 'CENTER'),

        ('SPAN', (9, 2), (10, 2)),
        ('BACKGROUND', (9, 2), (10, 2), colors.HexColor("#f6b26b")),
        ('ALIGN', (9, 2), (10, 2), 'CENTER'),

        ('SPAN', (11, 2), (13, 2)),
        ('BACKGROUND', (11, 2), (13, 2), colors.HexColor("#f9cb9c")),
        ('ALIGN', (11, 2), (13, 2), 'CENTER'),

        # Rainfall
        ('SPAN', (2, 3), (3, 3)),
        ('BACKGROUND', (2, 3), (3, 3), colors.HexColor("#fff2cc")),

    
        

        ('SPAN', (4, 3), (5, 3)),
        ('BACKGROUND', (4, 3), (5, 3), colors.HexColor("#9fc5e8")),
        ('ALIGN', (4, 3), (5, 3), 'CENTER'),

        ('SPAN', (6, 3), (10, 3)),
        ('BACKGROUND', (6, 3), (10, 3), colors.HexColor("#4ca5f8")),
        ('ALIGN', (6, 3), (10, 3), 'CENTER'),

        ('BACKGROUND', (11, 3), (11, 3), colors.HexColor("#9fc5e8")),
        ('SPAN', (12, 3), (13, 3)),
         ('BACKGROUND', (2, 3), (3, 3), colors.HexColor("#fff2cc")),

        # Flood
        ('SPAN', (6, 4), (10, 4)),
        ('BACKGROUND', (6, 4), (10, 4), colors.HexColor("#eb2b2b")),
        ('ALIGN', (6, 4), (10, 4), 'CENTER'),

        # Strong wind
        ('SPAN', (6, 5), (7, 5)),
        ('BACKGROUND', (6, 5), (7, 5), colors.HexColor("#f6b26b")),
        ('ALIGN', (6, 5), (7, 5), 'CENTER'),
    ]

    table = create_styled_table(calendar_data, [32.26, 80.65, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26, 32.26], True, True, custom_styles, "Hazard Calendar")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
        # Image is yet to come 
        
    heading = Paragraph("<b>4.1.4	Erosion hazard</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    elements.append(Paragraph("Several stretches of the village are experiencing severe river bank erosion. Silt gets deposited on the opposite side of the eroding bank. Erosion leads to permanent loss of land which impact the livelihood of the community.",non_indented_style))
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 4: Area of land eroded and accreted", table_sub_title) 
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    table_data=getErosionCharacteristics(village_id)
    table = create_styled_table(table_data, [40, 200, 130, 130], False, True, srNoStyle, "Erosion Characteristics")
    elements.append(table)
    elements.append(Spacer(1, 6))
    
    # Flood and erosion bullet points
    hazard_points = [
        "Flood frequency: almost every year. Agriculture land flooded almost twice a year and flood water stay in the field for 3-4 weeks",
        "River bank erosion severe with permanent loss of land and about 15 houses are close to eroding river bank."
    ]
    
    hazard_bullet_items = ListFlowable(
        [ListItem(Paragraph(text, styles["Normal"])) for text in hazard_points],
        bulletType='bullet',
        start='•',
        leftIndent=20,
        bulletFontName='Helvetica',
        bulletFontSize=10
    )
    
    elements.append(hazard_bullet_items)
    elements.append(Spacer(1, 6))
    
    
    
    # ----------------- 4.2 ----------------
    elements.append(PageBreak())
    elements.append(Spacer(1, 12))
    heading = Paragraph("<b>4.2	Vulnerability Assessment</b>", blue_sub_heading)
    elements.append(heading)
    elements.append(Spacer(1, 12))
    heading = Paragraph("<b>4.2.1 Social vulnerability </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 5: Vulnerable population", table_sub_title) 
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    custom_styles=[
         ('FONTNAME', (0, -2), (-1, -1), 'Helvetica-Bold'),
    ]
    custom_styles.extend(srNoStyle)
    data=getVulnerablePopulationTableData(village_id)
    table = create_styled_table(data, [40,260,100,100], False, True, custom_styles, "Vulnerable Population")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    
    # # Vulnerability bullet points
    # vulnerability_points = [
    #     "In addition to social vulnerability indicators, economically vulnerable group constitute 18% of household are below poverty line and 34% is priority household."
    # ]
    
    # vulnerability_bullet_items = ListFlowable(
    #     [ListItem(Paragraph(text, styles["Normal"])) for text in vulnerability_points],
    #     bulletType='bullet',
    #     start='•',
    #     leftIndent=20,
    #     bulletFontName='Helvetica',
    #     bulletFontSize=10
    # )
    
    # elements.append(vulnerability_bullet_items)
    elements.append(Spacer(1, 12))
    
    

    
    
    # ------------------------------------
    custom_styles2 = [
        # Merge header cells
        ('SPAN', (2, 0), (3, 0)),  # Merge 'HH with big cattle' and '%'
        ('SPAN', (4, 0), (5, 0)),  # Merge 'HH with small cattle' and '%'
        ('SPAN', (0, 0), (0, 1)),  # Merge Sr. No. cells
        ('SPAN', (1, 0), (1, 1)),  # Merge Count cells

        # Center align all text
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('BACKGROUND',(0,1),(-1,1),tb_header_bg),
        
        ('ALIGN', (0, 2), (0, -1), 'RIGHT'),
        ('FONTNAME', (0, 1), (-1, 1), 'Helvetica-Bold'),
         ('ALIGN', (2, 2), (-1, -1), 'RIGHT'),
        #  ('FONTNAME', (1, -1), (-1, -1), 'Helvetica-Bold'),
        ]
    
    heading = Paragraph("<b>4.2.2 Housing </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 6: Vulnerability assessment of houses", table_sub_title)
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 6: Vulnerability assessment of houses", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data, summary = getHousingData(village_id)
    table = create_styled_table(data, [40,90, 110, 50, 110, 100], False, True, custom_styles2, "Vulnerability Assessment")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    housing_vulnerability_points = [
        f"{summary['flood_max_pct']}% of house are in the high flood vulnerability category and {summary['erosion_max_pct']}% houses in the high erosion vulnerable category."
    ]
    
    housing_vulnerability_bullet_items = ListFlowable(
        [ListItem(Paragraph(text, styles["Normal"])) for text in housing_vulnerability_points],
        bulletType='bullet',
        start='•',
        leftIndent=20,
        bulletFontName='Helvetica',
        bulletFontSize=10
    )
    
    elements.append(housing_vulnerability_bullet_items)
    elements.append(Spacer(1, 12))
    
    # House Typology Table
    custom_styles=[
         ('ALIGN', (2, 1), (-1, -1), 'RIGHT'),
    ]
    custom_styles.extend(srNoStyle)
    sub_title=Paragraph("Table 4 7: Distribution of house by typology", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getHouseTypeData(village_id)
    table = create_styled_table(data, [40, 100, 90, 90, 90, 90], False, True, custom_styles, "House Typology")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Building Quality Table
    sub_title=Paragraph("Table 4 8: Building quality", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getBuildingQualityData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "Building Quality")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Plinth Height Table
    sub_title=Paragraph("Table 4 9: Plinth height of houses", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getPlinthHeightData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "Plinth Height")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Toilet Structural Quality Table
    sub_title=Paragraph("Table 4 10: Toilet structural quality", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getToiletStructuralQualityData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "Toilet Quality")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # House Repair Expense Table
    sub_title=Paragraph("Table 4 11: Approximate amount spent for house repair annually", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getHouseRepairExpenseData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "House Repair Expense")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Household Flood Loss Table
    sub_title=Paragraph("Table 4 12: Approximate average annual economic loss household incurred due to flood (as reported by community)", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getHouseholdFloodLossData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "Household Flood Loss")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Agriculture Flood Loss Table
    sub_title=Paragraph("Table 4 13: Approximate average annual economic loss agriculture/livelihood sector incurred due to flood (as reported by community)", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getAgricultureFloodLossData(village_id)
    table = create_styled_table(data, [40, 160, 150, 150], False, True, custom_styles, "Agriculture Flood Loss")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # -------- Road Infrastructure ---------
    heading = Paragraph("<b>4.2.3 Road Infrastructure </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    custom_styles=[
        ('SPAN', (0, 0), (0, 1)),  
        ('SPAN', (1, 0), (1, 1)),
        ('SPAN', (2, 0), (2, 1)),
        ('SPAN', (3, 0), (-1, 0)),
        ('BACKGROUND',(0,1),(-1,1),tb_header_bg),
        ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
         ('ALIGN', (2, 2), (-1, -1), 'RIGHT'),
    ]
    custom_styles.extend(srNoStyle) 
    
    # Road Flood Vulnerability Table
    sub_title=Paragraph("Table 4 14: Road typology and flood vulnerability category", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getRoadFloodVulnerabilityData(village_id)
    table = create_styled_table(data, [40, 120, 70, 70, 70, 70, 70], False, True, custom_styles, "Road Flood Vulnerability")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Road Erosion Vulnerability Table
    sub_title=Paragraph("Table 4 15: Road typology and erosion vulnerability", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getRoadErosionVulnerabilityData(village_id)
    table = create_styled_table(data, [40, 120, 70, 70, 70, 70, 70], False, True, custom_styles, "Road Erosion Vulnerability")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # --------------- 4.2.4	Educational Facilities -----------------
    heading = Paragraph("<b>4.2.4 Educational Facilities </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    custom_styles_edu = [
        ('SPAN', (0, 0), (0, 1)),
        ('SPAN', (1, 0), (1, 1)),
        ('SPAN', (2, 0), (2, 1)),
        ('SPAN', (3, 0), (6, 0)),
        ('SPAN', (7, 0), (10, 0)),
        ('BACKGROUND',(0,1),(-1,1),tb_header_bg),
        # ('ALIGN', (0, 0), (1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ALIGN', (2, 2), (-1, -1), 'RIGHT')
    ]
    custom_styles_edu.extend(srNoStyle)
    
    sub_title=Paragraph("Table 4 16: Educational facilities and flood & erosion vulnerability", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getEducationalFacilitiesData(village_id)
    table = create_styled_table(data, [30, 100, 40, 40, 40, 40, 40, 40, 40, 40, 40], False, True, custom_styles_edu, "Educational Facilities")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    heading = Paragraph("<b>4.2.5	Health Facilities</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    elements.append(Paragraph("No health facilities within the village. Nearest health facility is located 3 km from the village.",non_indented_style))
    
    # --------------- Other Assets -----------------
    heading = Paragraph("<b>4.2.6 Other Assets </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 17: Other Assets flood & erosion vulnerability", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getOtherAssetsData(village_id)
    table = create_styled_table(data, [30, 100, 40, 40, 40, 40, 40, 40, 40, 40, 40], False, True, custom_styles_edu, "Other Assets")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # --------------- Power Infrastructure -----------------
    heading = Paragraph("<b>4.2.7 Power Infrastructure </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 18: Power infrastructure facilities and flood & erosion vulnerability", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getPowerInfrastructureData(village_id)
    table = create_styled_table(data, [30, 100, 40, 40, 40, 40, 40, 40, 40, 40, 40], False, True, custom_styles_edu, "Power Infrastructure")
    elements.append(table)
    elements.append(Spacer(1, 12))
    image_height = page_height * 0.6

    #img from model if not available get from geoserver
    # img_field = map_file_fields['electrical_infrastructure'] if map_file_fields else None
    # if img_field:
    #     # Get the full file path (works for local storage)
    #     img_path = f"{MEDIA_ROOT}/{img_field}"

    #     # Create a ReportLab Image object
    #     img = ReportLabImage(img_path, width=450, height=image_height)  # adjust size

    #     # Put the Image object inside a table
    #     img_table = ReportLabTable([[img]])
    #     img_table.setStyle(TableStyle([('BOX', (0, 0), (-1, -1), 1, colors.black)]))

    #     elements.append(img_table)
    #     elements.append(Spacer(1, 12))
    #     sub_title=Paragraph("Figure 4 3: Electrical infrastructure", image_title)
    #     elements.append(sub_title)
    # --------------- Livelihood Vulnerability Assessment -----------------
    heading = Paragraph("<b>4.2.8 Livelihood Vulnerability Assessment </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    # Exposure Table
    sub_heading = Paragraph("<b>Exposure</b>", bold_style)
    elements.append(sub_heading)
    elements.append(Spacer(1, 6))
    
    # sub_title=Paragraph("Livelihood Vulnerability Index-Rupakuchi, Barpeta, Assam", table_sub_title)
    # elements.append(sub_title)
    # elements.append(Spacer(1, 6))
    
    custom_styles_lvi = [
        ('ALIGN', (0, 0), (-1, 1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, 1), 'MIDDLE'),
        ('ALIGN', (3, 1), (3, -1), 'RIGHT'),
        ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
        ('SPAN',(0,0),(-1, 0)),
        ('BACKGROUND',(0,0),(-1, 1),tb_header_bg),
    ]
    custom_styles_lvi.extend(srNoStyle)
    
    data=getLivelihoodExposureData(village_id)
    table = create_styled_table(data, [30, 150, 250, 70], False, True, custom_styles_lvi, "Livelihood Exposure")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Sensitivity Table
    sub_heading = Paragraph("<b>Sensitivity</b>", bold_style)
    elements.append(sub_heading)
    elements.append(Spacer(1, 6))
    custom_styles_lvi = [
        # ('ALIGN', (0, 0), (-1, 1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, 1), 'MIDDLE'),
        ('ALIGN', (3, 1), (3, -1), 'RIGHT'),
        ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
        # ('SPAN',(0,0),(-1, 0)),
        # ('BACKGROUND',(0,0),(-1, 1),tb_header_bg),
    ]
    custom_styles_lvi.extend(srNoStyle)
    data=getLivelihoodSensitivityData(village_id)
    table = create_styled_table(data, [30, 150, 250, 70], False, True, custom_styles_lvi, "Livelihood Sensitivity")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Adaptive Capacity Table
    sub_heading = Paragraph("<b>Adaptive Capacity</b>", bold_style)
    elements.append(sub_heading)
    elements.append(Spacer(1, 6))
    
    data=getLivelihoodAdaptiveCapacityData(village_id)
    table = create_styled_table(data, [30, 150, 250, 70], False, True, custom_styles_lvi, "Livelihood Adaptive Capacity")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # LVI Score
    lvi_text = Paragraph("<b>LVI Score = 0.54 (Medium)</b>", bold_style)
    elements.append(lvi_text)
    elements.append(Spacer(1, 6))
    
    note_text = Paragraph("<b>Note:</b> LVI class - 0.00 – 0.20 (Very Low), 0.21 – 0.40 (Low), 0.41 – 0.60 (Medium), 0.61 – 0.80 (High) and 0.81 – 1.00 (Very High)", normal_style)
    elements.append(note_text)
    elements.append(Spacer(1, 12))
    
    # --------------- Environmental Vulnerability -----------------
    heading = Paragraph("<b>4.2.9 Environmental Vulnerability </b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 19: Environmental characteristics", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    
    custom_styles_env = [
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE')
    ]
    custom_styles_env.extend(srNoStyle)
    
    data=getEnvironmentalCharacteristicsData(village_id)
    table = create_styled_table(data, [30, 230, 240], False, True, custom_styles_env, "Environmental Characteristics")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    
    
    # ----------------- 4.3 ----------------
    heading = Paragraph("<b>4.3	Risk Assessment </b>", blue_heading)
    elements.append(heading)
    p=Paragraph("The risk assessment (potential economic loss) due to flood, earthquake and strong wind for different sectors are provided below", non_indented_style)
    elements.append(p)
    elements.append(Spacer(1, 6))
    custom_styles=[ ('ALIGN', (2, 2), (-1, -1), 'RIGHT')]
    custom_styles.extend(srNoStyle)
    heading = Paragraph("<b>4.3.1 Potential economic loss due to flood (scenario 2022)</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    sub_title=Paragraph("Table 4 20: Potential maximum loss scenario for different building occupancy", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getFloodLossBuildingsTableData()
    table = create_styled_table(data, [40,160,100,100,100], False, True, custom_styles, "Flood Loss Buildings")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # -------------------
    sub_title=Paragraph("Table 4 21: Potential maximum loss scenario for roads and agriculture ", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getFloodLossRoadsAgriTableData()
    table = create_styled_table(data, [40,160, 100, 100, 100], False, True, custom_styles, "Flood Loss Roads Agriculture")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Average Loss Scenario
    sub_title=Paragraph("Table 4 22: Average loss scenario for roads and agriculture", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getAverageLossRoadsAgriTableData()
    table = create_styled_table(data, [40,160, 100, 100, 100], False, True, custom_styles, "Average Loss Roads Agriculture")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # --------------- Earthquake Risk Assessment -----------------
    heading = Paragraph("<b>4.3.2 Potential economic loss due to Earthquake (475-year Return Period)</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 23: Potential maximum loss scenario due to earthquake for different building occupancy", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getEarthquakeLossBuildingsTableData()
    table = create_styled_table(data, [40,160, 100, 100, 100], False, True, custom_styles, "Earthquake Loss Buildings")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # --------------- Cyclone/Strong Wind Risk Assessment -----------------
    heading = Paragraph("<b>4.3.3 Potential economic loss due to cyclone/strong wind (100-year Return Period)</b>", blue_level3_heading)
    elements.append(heading)
    elements.append(Spacer(1, 6))
    
    sub_title=Paragraph("Table 4 24: Potential maximum loss scenario due to cyclone/strong wind for different building occupancy", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getCycloneLossBuildingsTableData()
    table = create_styled_table(data, [40,160, 100, 100, 100], False, True, custom_styles, "Cyclone Loss Buildings")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    # Strong Wind Agriculture Loss
    sub_title=Paragraph("Table 4 25: Potential maximum loss scenario due to strong wind for agriculture", table_sub_title)
    elements.append(sub_title)
    elements.append(Spacer(1, 6))
    data=getStrongWindAgricultureTableData()
    table = create_styled_table(data, [40,160, 100, 100, 100], False, True, custom_styles, "Strong Wind Agriculture Loss")
    elements.append(table)
    elements.append(Spacer(1, 12))
    
    
    
    